name: Sync

on:
  schedule:
    - cron: '0 4 * * 3,6' # at 4am on wed & sat
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [15.x]

    steps:
      - name: ⏬ Checkout code
        uses: actions/checkout@v2

      - name: 🔢 Use Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v2
        with:
          node-version: ${{ matrix.node-version }}

      - name: ⏬ Install
        run: |
          npm install

      - name: 🌏 Download planet file extract
        run: |
          yarn download-planet

      - name: 🥝 Download LINZ csv file
        run: |
          yarn download-linz

      - name: 🚚 Preprocess the .csv and .osm.pbf files
        run: |
          yarn preprocess --max-old-space-size=7168

      - name: 🔁 Conflate LINZ data with OSM
        run: |
          yarn conflate --max-old-space-size=7168

      - name: 🏡 Generate geojson and reports
        run: |
          yarn action --max-old-space-size=7168

      - name: ⛅ Upload geojson and reports to CDN
        run: |
          yarn upload --max-old-space-size=7168
        env:
          GH_BASIC_AUTH: ${{ secrets.GH_BASIC_AUTH }}
          AZ_CON: ${{ secrets.AZ_CON }}
